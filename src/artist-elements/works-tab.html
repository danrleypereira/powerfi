<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/collectar-elements/collectar-service/collectar-service.html">

<dom-module id="works-tab">
  <template>
    <style>
      :host {
        display: block;
        padding: 20px 40px;
        min-height: 100vh;
      }
      .tab-heading {
        margin: 0;
        font-size: 4rem;
      }
      .formation-block {
        display: grid;
        grid-template-columns: 60% 40%;
        margin: 10px 0 30px;
      }
      .formation-block:last-of-type {
        margin-bottom: 0;
      }
      .text-inline-left {
        flex: 1;
        margin-right: 40px;
      }
      .text-inline-right{
        flex: 1;
        margin-left: 40px;
      }
      p {
        margin: 0 0 10px;
        font-size: 0.975rem;
        line-height: 1.85;
        min-height: 235px;
        font-family: 'Comfortaa', cursive !important;
        opacity: 0.7;
      }
      .text-image {
        flex: 1;
      }
      .text-image iron-image {
        width: 100%;
        height: 100%;
        min-height: 325px;
        background: #ccc;
      }
      .text-image.small {
        max-width: 80px;
        min-width: 80px;
        height: 80px;
        margin: 0 2px;
      }
      .text-image.small iron-image {
        min-height: 80px;
      }
      .images {
        display: flex;
        height: 80px;
        overflow-x: auto;
        overflow-y: hidden;
        background: #ccc;
      }
      h1:not(.tab-heading) {
        margin-top: 1.2rem;
      }
      @media screen and (max-width: 960px) {
        .formation-block {
          display: grid;
          grid-template-columns: 50% 50%;
          margin: 10px 0 30px;
        }
        .tab-heading {
          font-size: 3.5rem;
        }
        .text-inline-left {
          flex: 2;
        }
        p {
          min-height: 120px;
        }
        .text-image iron-image {
            min-height: 200px;
        }
      }
      @media screen and (max-width: 800px) {
        .text-image iron-image {
          width: 100%;
        }
        .formation-block {
          grid-template-columns: 100%;
        }
        h1 {
          font-size: 1.8rem;
        }
        .text-image {
          max-width: unset;
          margin-bottom: 10px;
        }
        .text-inline-right,
        .text-inline-left {
          margin: 0;
        }
      }
      @media screen and (max-width: 660px) {
        :host {
          display: block;
          padding: 20px 20px;
        }
        .tab-heading {
          font-size: 2.3rem;
        }
        h1 {
          font-size: 1.3rem;
        }
      }
      @media screen and (max-width: 500px) {
        h1 {
          font-size: 1.3rem;
        }
      }
    </style>
    <collectar-service id="ajax" api="https://acervo.miltonribeiro.org/api" service="{{service}}">
    </collectar-service>
    <div class="content">
      <h1 class="tab-heading">Obras</h1>
      <template is="dom-repeat" items="{{series}}" as="serie">
        <div class="formation">
          <h1>{{serie.name}}</h1>
          <div class="formation-block reverse">
            <div class="text-inline-left">
              <p>
                {{serie.description}}
              </p>
              <div class="images">
                <template is="dom-repeat" items="{{serie._items}}">
                  <div class="text-image small">
                    <iron-image src="{{thumbPath(item._data.PhotoFields)}}" sizing="contain"></iron-image>
                  </div>
                  <div class="text-image small">
                    <iron-image src="{{thumbPath(item._data.PhotoFields)}}" sizing="contain"></iron-image>
                  </div>
                  <div class="text-image small">
                    <iron-image src="{{thumbPath(item._data.PhotoFields)}}" sizing="contain"></iron-image>
                  </div>
                  <div class="text-image small">
                    <iron-image src="{{thumbPath(item._data.PhotoFields)}}" sizing="contain"></iron-image>
                  </div>
                </template>
              </div>
            </div>
            <div class="text-image">
              <iron-image placeholder="{{serie.selected._data.PhotoFields.thumbnail}}" preload
                src="{{imgPath(serie.selected._data.PhotoFields)}}" sizing="contain"></iron-image>
            </div>
          </div>
        </template>
      </div>
    </div>
  </template>

  <script>
    class WorksTab extends Polymer.Element {
      static get is() { return 'works-tab'; }
      static get properties() {
        return {
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String,
          projectId: {
            type: String,
            value: '59801055c86b1e6a8bf6c36f',
            observer: 'computeService'
          },
          service: String,
          series: Array,
        };
      }
      computeService(projectId) {
        let promises = [];
        this.service = `projects/${projectId}/taxonomies?search=sÃ©ries`;
        this.$.ajax.generateRequest().then((ajax) => {
          const res = ajax.response[0];
          if(!res || !res._children) return [];
          this.taxonomies = res._children;
          promises = res._children.map((tax) => {
            this.service = `projects/${projectId}/items?taxonomies=${tax._id}&limit=5`;
            return this.$.ajax.generateRequest();
          });
          return Promise.all(promises);
        })
        .then((results) => {
          this.series = results.map((list, i) => {
            this.taxonomies[i]._items = list.response.results;
            this.taxonomies[i].selected = list.response.results[0];
            return this.taxonomies[i];
          });
        });
      }
      imgPath(photoFields) {
        if(!photoFields || !photoFields._medias.length) return;
        const filename = photoFields._medias[0].filename;
        return `${this.$.ajax.api}/projects/${this.projectId}/medias/${photoFields._item}/${filename}?size=500`;
      }
      thumbPath(photoFields) {
        if(!photoFields || !photoFields._medias.length) return;
        const filename = photoFields._medias[0].filename;
        return `${this.$.ajax.api}/projects/${this.projectId}/medias/${photoFields._item}/${filename}?size=160`;
      }
    }

    window.customElements.define(WorksTab.is, WorksTab);
  </script>
</dom-module>
